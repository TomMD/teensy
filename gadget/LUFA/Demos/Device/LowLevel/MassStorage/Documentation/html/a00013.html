<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LUFA Library - Mass Storage Device Demo: MassStorage.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>MassStorage.c File Reference</h1><code>#include &quot;<a class="el" href="a00014.html">MassStorage.h</a>&quot;</code><br/>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a6a6685f278c6a387f58a9a4f8b692134">INCLUDE_FROM_MASSSTORAGE_C</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a840291bc02cba5474a4cb46a9b9566fe">main</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#acb27e569c06a2797c5fd58ed39147448">SetupHardware</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#aeff97648c9250a3d398bb0b74f040899">EVENT_USB_Device_Connect</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#ae88405d14d8d6dada9313520cb1501ec">EVENT_USB_Device_Disconnect</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a953a275884b9e33629ff6323fca05252">EVENT_USB_Device_ConfigurationChanged</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#abbebc3cb66ac3945b938ae5b93a71ea8">EVENT_USB_Device_UnhandledControlRequest</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a2366751aad393f7e49384b76dfdbfc05">MassStorage_Task</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a198e781643cf3ee5aa8bea888b3a2ab4">ReadInCommandBlock</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a35e2afa9515551556bdb41d29f6b9eb2">ReturnCommandStatus</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a0404d021554ccc86fcb2b40c3083aeb4">StreamCallback_AbortOnMassStoreReset</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="a00001.html">CommandBlockWrapper_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#a31780559e7a9c322e16adb1d2ef4625e">CommandBlock</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="a00002.html">CommandStatusWrapper_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#adbb7d1de681baffcbb200c3c4eb8e73e">CommandStatus</a> = { .Signature = CSW_SIGNATURE }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">volatile bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00013.html#aa696f7a79b9109ea7f508d87861e1bf9">IsMassStoreReset</a> = false</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Main source file for the Mass Storage demo. This file contains the main tasks of the demo and is responsible for the initial application hardware configuration. </p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a6a6685f278c6a387f58a9a4f8b692134"></a><!-- doxytag: member="MassStorage.c::INCLUDE_FROM_MASSSTORAGE_C" ref="a6a6685f278c6a387f58a9a4f8b692134" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define INCLUDE_FROM_MASSSTORAGE_C</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a953a275884b9e33629ff6323fca05252"></a><!-- doxytag: member="MassStorage.c::EVENT_USB_Device_ConfigurationChanged" ref="a953a275884b9e33629ff6323fca05252" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EVENT_USB_Device_ConfigurationChanged </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Event handler for the USB_ConfigurationChanged event. This is fired when the host set the current configuration of the USB device after enumeration - the device endpoints are configured and the Mass Storage management task started. </p>

</div>
</div>
<a class="anchor" id="aeff97648c9250a3d398bb0b74f040899"></a><!-- doxytag: member="MassStorage.c::EVENT_USB_Device_Connect" ref="aeff97648c9250a3d398bb0b74f040899" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EVENT_USB_Device_Connect </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Event handler for the USB_Connect event. This indicates that the device is enumerating via the status LEDs. </p>

</div>
</div>
<a class="anchor" id="ae88405d14d8d6dada9313520cb1501ec"></a><!-- doxytag: member="MassStorage.c::EVENT_USB_Device_Disconnect" ref="ae88405d14d8d6dada9313520cb1501ec" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EVENT_USB_Device_Disconnect </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Event handler for the USB_Disconnect event. This indicates that the device is no longer connected to a host via the status LEDs and stops the Mass Storage management task. </p>

</div>
</div>
<a class="anchor" id="abbebc3cb66ac3945b938ae5b93a71ea8"></a><!-- doxytag: member="MassStorage.c::EVENT_USB_Device_UnhandledControlRequest" ref="abbebc3cb66ac3945b938ae5b93a71ea8" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void EVENT_USB_Device_UnhandledControlRequest </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Event handler for the USB_UnhandledControlPacket event. This is used to catch standard and class specific control requests that are not handled internally by the USB library (including the Mass Storage class-specific requests) so that they can be handled appropriately for the application. </p>

</div>
</div>
<a class="anchor" id="a840291bc02cba5474a4cb46a9b9566fe"></a><!-- doxytag: member="MassStorage.c::main" ref="a840291bc02cba5474a4cb46a9b9566fe" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Main program entry point. This routine configures the hardware required by the application, then enters a loop to run the application tasks in sequence. </p>

</div>
</div>
<a class="anchor" id="a2366751aad393f7e49384b76dfdbfc05"></a><!-- doxytag: member="MassStorage.c::MassStorage_Task" ref="a2366751aad393f7e49384b76dfdbfc05" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void MassStorage_Task </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Task to manage the Mass Storage interface, reading in Command Block Wrappers from the host, processing the SCSI commands they contain, and returning Command Status Wrappers back to the host to indicate the success or failure of the last issued command. </p>

</div>
</div>
<a class="anchor" id="a198e781643cf3ee5aa8bea888b3a2ab4"></a><!-- doxytag: member="MassStorage.c::ReadInCommandBlock" ref="a198e781643cf3ee5aa8bea888b3a2ab4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool ReadInCommandBlock </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Function to read in a command block from the host, via the bulk data OUT endpoint. This function reads in the next command block if one has been issued, and performs validation to ensure that the block command is valid.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>Boolean true if a valid command block has been read in from the endpoint, false otherwise </dd></dl>

</div>
</div>
<a class="anchor" id="a35e2afa9515551556bdb41d29f6b9eb2"></a><!-- doxytag: member="MassStorage.c::ReturnCommandStatus" ref="a35e2afa9515551556bdb41d29f6b9eb2" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ReturnCommandStatus </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Returns the filled Command Status Wrapper back to the host via the bulk data IN endpoint, waiting for the host to clear any stalled data endpoints as needed. </p>

</div>
</div>
<a class="anchor" id="acb27e569c06a2797c5fd58ed39147448"></a><!-- doxytag: member="MassStorage.c::SetupHardware" ref="acb27e569c06a2797c5fd58ed39147448" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SetupHardware </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Configures the board hardware and chip peripherals for the demo's functionality. </p>

</div>
</div>
<a class="anchor" id="a0404d021554ccc86fcb2b40c3083aeb4"></a><!-- doxytag: member="MassStorage.c::StreamCallback_AbortOnMassStoreReset" ref="a0404d021554ccc86fcb2b40c3083aeb4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t StreamCallback_AbortOnMassStoreReset </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Stream callback function for the Endpoint stream read and write functions. This callback will abort the current stream transfer if a Mass Storage Reset request has been issued to the control endpoint. </p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a31780559e7a9c322e16adb1d2ef4625e"></a><!-- doxytag: member="MassStorage.c::CommandBlock" ref="a31780559e7a9c322e16adb1d2ef4625e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00001.html">CommandBlockWrapper_t</a> <a class="el" href="a00014.html#a31780559e7a9c322e16adb1d2ef4625e">CommandBlock</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Structure to hold the latest Command Block Wrapper issued by the host, containing a SCSI command to execute. </p>

</div>
</div>
<a class="anchor" id="adbb7d1de681baffcbb200c3c4eb8e73e"></a><!-- doxytag: member="MassStorage.c::CommandStatus" ref="adbb7d1de681baffcbb200c3c4eb8e73e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00002.html">CommandStatusWrapper_t</a> <a class="el" href="a00014.html#adbb7d1de681baffcbb200c3c4eb8e73e">CommandStatus</a> = { .Signature = CSW_SIGNATURE }</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Structure to hold the latest Command Status Wrapper to return to the host, containing the status of the last issued command. </p>

</div>
</div>
<a class="anchor" id="aa696f7a79b9109ea7f508d87861e1bf9"></a><!-- doxytag: member="MassStorage.c::IsMassStoreReset" ref="aa696f7a79b9109ea7f508d87861e1bf9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile bool <a class="el" href="a00014.html#aa696f7a79b9109ea7f508d87861e1bf9">IsMassStoreReset</a> = false</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Flag to asynchronously abort any in-progress data transfers upon the reception of a mass storage reset command. </p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Dec 2009 for LUFA Library - Mass Storage Device Demo by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
